@{
    Layout = null;
}

<!DOCTYPE html>
<html>

<head>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', 'Georgia', sans-serif;
            background-color: #121212;
            color: #ffffff;
        }

        .blog-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .blog-title {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 15px;
            color: #ffffff;
        }

        .blog-subtitle {
            font-size: 24px;
            font-weight: 400;
            color: #cccccc;
            margin-bottom: 30px;
        }

        .author-section {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .author-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 15px;
        }

        .author-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .author-info {
            flex-grow: 1;
        }

        .author-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .publication-info {
            display: flex;
            font-size: 14px;
            color: #aaaaaa;
        }

        .publication-info span {
            margin-right: 10px;
        }

        .follow-btn {
            background-color: #FFD700;
            /* Yellow */
            color: #000000;
            padding: 5px 15px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .follow-btn:hover {
            background-color: #E6C200;
        }

        .blog-content {
            line-height: 1.8;
            font-size: 18px;
            margin-bottom: 40px;
        }

        .blog-content p {
            margin-bottom: 25px;
        }

        .reaction-section {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }

        .reactions-left {
            display: flex;
            align-items: center;
        }

        .reaction-btn {
            background: none;
            border: none;
            color: #ffffff;
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }

        .reaction-btn i {
            margin-right: 5px;
            color: #FFD700;
            /* Yellow */
            font-size: 20px;
            /* Increased icon size */
        }

        .highlight {
            color: #FFD700;
            /* Yellow for highlights */
        }

        /* Comment section styles */
        .comments-section {
            margin-top: 50px;
            border-top: 1px solid #333;
            padding-top: 30px;
        }

        .comments-header {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .comment-form {
            margin-bottom: 30px;
        }

        .comment-input {
            width: 100%;
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            color: #ffffff;
            font-size: 16px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 15px;
        }

        .comment-submit {
            background-color: #FFD700;
            color: #000000;
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .comment-submit:hover {
            background-color: #E6C200;
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .comment {
            background-color: #1e1e1e;
            border-radius: 10px;
            padding: 15px;
        }

        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .commenter-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            overflow: hidden;
        }

        .commenter-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .commenter-name {
            font-weight: 600;
            margin-right: 10px;
        }

        .comment-date {
            color: #aaaaaa;
            font-size: 12px;
        }

        .comment-body {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            /* Add space below actions */
        }

        .comment-action {
            color: #aaaaaa;
            font-size: 14px;
            cursor: pointer;
            background: none;
            border: none;
            display: flex;
            align-items: center;
        }

        .comment-action i {
            margin-right: 5px;
            font-size: 16px;
        }

        .comment-action:hover {
            color: #FFD700;
        }

        .nested-comments {
            margin-left: 50px;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .reply-form {
            margin: 10px 0 15px 0;
            /* Better vertical spacing */
            display: none;
            border-radius: 8px;
            overflow: hidden;
            /* Ensure rounded corners work with child elements */
        }

        .reply-form.active {
            display: block;
        }

        .reply-form .comment-input {
            border-radius: 8px;
            resize: none;
            /* Prevent manual resizing */
            min-height: 60px;
            /* Shorter height for replies */
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
            /* Ensure padding doesn't break width */
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            /* Subtle shadow */
        }

        .reply-form .comment-submit {
            display: inline-block;
            float: right;
            /* Position on the right */
            margin-bottom: 5px;
            /* Space below button */
        }

        /* Clear float after the button */
        .reply-form:after {
            content: "";
            display: table;
            clear: both;
        }

        @@media (max-width: 768px) {
            .blog-title {
                font-size: 32px;
            }

            .blog-subtitle {
                font-size: 20px;
            }

            .author-section {
                flex-wrap: wrap;
            }

            .nested-comments {
                margin-left: 20px;
            }
        }

        /* Bookmark button styles */
        .bookmark-btn {
            background: none;
            border: none;
            color: #FFD700;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: absolute;
            top: 40px;
            right: 20px;
            padding: 10px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .bookmark-btn:hover {
            transform: scale(1.1);
            background-color: rgba(0, 0, 0, 0.7);
        }

        .bookmark-btn.active {
            color: #FFD700;
        }

        .bookmark-btn:not(.active) {
            color: #aaaaaa;
        }

        /* Medium-style floating reaction buttons */
        .reaction-floating {
            position: fixed;
            left: calc(50% - 400px - 100px);
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 15px 0;
            border-radius: 30px;
            background-color: rgba(30, 30, 30, 0.8);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .reaction-floating .reaction-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #2a2a2a;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
        }

        .reaction-floating .reaction-btn i {
            margin: 0;
            font-size: 24px;
        }

        .reaction-floating .reaction-count {
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
            color: #aaaaaa;
        }

        .reaction-floating .reaction-btn:hover {
            background-color: #3a3a3a;
            transform: scale(1.1);
        }

        .reaction-floating .reaction-btn.active {
            background-color: rgba(255, 215, 0, 0.2);
        }

        .reaction-floating .reaction-btn.active i {
            color: #FFD700;
        }

        /* Blog stats section */
        .blog-stats {
            display: flex;
            gap: 15px;
            color: #aaaaaa;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .blog-stats-item {
            display: flex;
            align-items: center;
        }

        .blog-stats-item i {
            margin-right: 5px;
            font-size: 16px;
        }

        /* Fixed addNewReply function bug */
        .error-message {
            background-color: #ffdddd;
            color: #ff0000;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .author-comment {
            @* border-left: 4px solid #007BFF; *@
            @* background-color: #f0f8ff; *@
        }

        .author-badge {
            background-color: #007BFF;
            color: white;
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 4px;
            margin-left: 8px;
        }
    </style>
</head>

<body>
    <!-- Blog Content -->
    <div class="blog-container" id="blog-container">
        <!-- Content will be loaded dynamically -->
        <div id="loading-indicator" style="text-align: center; padding: 50px;">
            <i class="fa-solid fa-spinner fa-spin fa-2xl"></i>
            <p>Loading blog content...</p>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>

        document.addEventListener('DOMContentLoaded', function () {

            // Define commentsData globally within this scope
            let commentsData = [];
            let BLOG_ID = -1;
            let USER_OBJECT = null;
            let USER_ROLE = "user"; // by default set to "user"
            let USER_ID = getUserIdFromToken();

            if(!USER_ID) {
                console.warn("No Authentication");
            } else {
                console.log(USER_OBJECT);
                console.log(USER_ID);
                console.log(USER_ROLE);
            }

            // Start of Flow
            loadBlogData();


            @* Utility Functions *@
            function parseJwt(token) {
                try {
                    const base64Url = token.split(".")[1];
                    const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
                    return JSON.parse(atob(base64));
                } catch (error) {
                    console.error("Invalid token:", error);
                    return null;
                }
            }
            function getUserIdFromToken() {
                const token = localStorage.getItem("authToken");
                if (!token) {
                    console.warn("No auth token found in localStorage.");
                    return null;
                }
                const jwt_decoded = parseJwt(token);
                if (jwt_decoded) {
                    USER_OBJECT = JSON.parse(jwt_decoded.UserObject);
                    if (USER_OBJECT.instructorId) {
                        USER_ROLE = "instructor";
                        return USER_OBJECT.instructorId;
                    } else {
                        USER_ROLE = "user";
                        return USER_OBJECT.userId;
                    }
                }
                console.warn("Invalid or malformed token.");
                return null;
            }

            // Extract the blog post ID from the URL
            function getBlogPostIdFromUrl() {
                const urlParts = window.location.pathname.split('/');
                return urlParts[urlParts.length - 1];
            }


            // Function to fetch blog data
            function loadBlogData() {
                const blogPostId = getBlogPostIdFromUrl();
                const url = `http://localhost:8080/api/Blog/fetchBlogByUri?source_uri=${blogPostId}`;

                $.ajax({
                    url: url,
                    method: 'POST',
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            const blogData = response.data;
                            BLOG_ID = response.data.c_blog_id;
                            // After getting blog data, fetch author info
                            fetchAuthorInfo(blogData);
                        } else {
                            console.error('Error fetching blog data:', response.message);
                            renderBlogPost(getSampleBlogData());
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching blog data:', error);
                        // Load sample data as fallback
                        renderBlogPost(getSampleBlogData());
                    }
                });
            }

            // Function to fetch author info
            function fetchAuthorInfo(blogData) {
                const authorId = blogData.c_blog_author_id;
                const url = `http://localhost:8080/api/Blog/fetchBlogAuthorById?author_id=${authorId}`;

                $.ajax({
                    url: url,
                    method: 'POST',
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            const authorData = response.data;
                            // Combine blog and author data
                            const combinedData = {
                                ...blogData,
                                c_authorname: authorData.instructorName,
                                c_authorspecification: authorData.specialization,
                                c_profilePicture: authorData.profileImage,
                                isBookmarked: false // Default value
                            };

                            // Render blog with combined data
                            renderBlogPost(combinedData);

                            // After rendering blog, fetch comments
                            fetchComments(blogData.c_blog_id);
                        } else {
                            console.error('Error fetching author data:', response.message);
                            renderBlogPost(blogData);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching author data:', error);
                        renderBlogPost(blogData);
                    }
                });
            }

            // Function to fetch comments
            function fetchComments(blogId) {
                const url = `http://localhost:8080/api/Blog/fetchBlogComments?blogId_=${blogId}`;

                $.ajax({
                    url: url,
                    method: 'POST',
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            // Process comments to match our expected format
                            const formattedComments = processComments(response.data.entries);
                            commentsData = formattedComments;
                            loadComments(formattedComments);
                        } else {
                            console.error('Error fetching comments:', response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching comments:', error);
                    }
                });
            }

            // Process comments from API format to our format
            function processComments(apiComments) {
                return apiComments.map(comment => {
                    // Format date from Unix timestamp
                    const commentDate = new Date(comment.commentedAt * 1000);
                    const formattedDate = formatDateTime(commentDate);

                    return {
                        id: comment.commentId.toString(),
                        parent_id: comment.parentCommentId === -1 ? null : comment.parentCommentId.toString(),
                        author: comment.authorName,
                        avatar: comment.authorProfilePicture,
                        date: formattedDate,
                        text: comment.commentContent,
                        isAuthorComment: (comment.userRole == "instructor" && comment.blogId == BLOG_ID)
                    };
                });
            }

            // Format date and time for displaying
            function formatDateTime(date) {
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function formatDateTimeFromUnix(unixTimestamp) {
                const date = new Date(unixTimestamp * 1000); // Convert seconds to milliseconds
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // Sample blog data for fallback
            function getSampleBlogData() {
                return {
                    c_title: "The Art of Fitness: Finding Your Perfect Workout Routine",
                    c_desc: "Discover how personalized fitness can transform your health journey",
                    c_authorname: "Alex Johnson",
                    c_profilePicture: "https://media.istockphoto.com/id/1300845620/vector/user-icon-flat-isolated-on-white-background-user-symbol-vector-illustration.jpg?s=612x612&w=0&k=20&c=yBeyba0hUkh14_jgv1OKqIH0CCSWU_4ckRkAoy2p73o=",
                    c_authorspecification: "Fitness Coach & Nutritionist",
                    c_published_at: 1686841200, // June 15, 2023 in Unix epoch time
                    c_content: `<p>
                        The journey to fitness is deeply personal. What works for one person might not work for another.
                        This is why understanding your body's unique needs is the first step toward achieving your fitness goals.
                        </p>`,
                    c_likes: 128,
                    c_comments: 24,
                    c_views: 1563,
                    isBookmarked: false
                };
            }

            // Function to render blog post with provided data
            function renderBlogPost(blogData) {
                // Decode base64 content if it exists
                let contentHtml = blogData.c_content;
                if (contentHtml && contentHtml.indexOf('<') === -1) {
                    // This might be base64 encoded
                    try {
                        contentHtml = atob(contentHtml);
                    } catch (e) {
                        console.error('Error decoding content:', e);
                    }
                }

                // Format the date from Unix epoch time
                const publishDate = new Date(blogData.c_published_at * 1000);
                const formattedDate = publishDate.toLocaleDateString('en-US', {
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });

                // Estimated read time calculation (rough estimate based on word count)
                const wordCount = contentHtml.split(' ').length;
                const readMinutes = Math.max(1, Math.round(wordCount / 200)); // Assuming average reading speed of 200 words per minute

                // Format profile picture URL
                let profilePicUrl = blogData.c_profilePicture;
                if (profilePicUrl && !profilePicUrl.startsWith('http')) {
                    profilePicUrl = `http://localhost:8081/Instructor_Images/${profilePicUrl}`;
                }

                // Create HTML for blog content
                const blogHtml = `
                    <!-- Bookmark button -->
                    <button class="bookmark-btn" id="bookmark-button">
                        <i class="fa-${blogData.isBookmarked ? 'solid' : 'regular'} fa-bookmark"></i>
                    </button>

                    <h1 class="blog-title">${blogData.c_title}</h1>
                    <h2 class="blog-subtitle">${blogData.c_desc}</h2>

                    <div class="author-section">
                        <div class="author-image">
                            <img src="${profilePicUrl}" alt="Author profile"
                            >
                        </div>
                        <div class="author-info">
                            <div class="author-name">${blogData.c_authorname}</div>
                            <div class="publication-info">
                                <span>${blogData.c_authorspecification || 'Author'}</span>
                                <span>•</span>
                                <span>${readMinutes} min read</span>
                                <span>•</span>
                                <span>${formattedDate}</span>
                            </div>
                        </div>
                        <button class="like-blog-btn" id="like-blog-btn">
                            <i class="fa-${blogData.isLiked ? 'solid' : 'regular'} fa-heart"></i>
                            <span class="like-text">${blogData.isLiked ? 'Liked' : 'Like'}</span>
                        </button>
                    </div>

                    <!-- Blog stats section -->
                    <div class="blog-stats">
                        <div class="blog-stats-item">
                            <i class="fa-solid fa-eye"></i> ${blogData.c_views || 0} views
                        </div>
                        <div class="blog-stats-item like-stats" role="button">
                            <i class="fa-solid fa-heart"></i> <span class="like-count">${blogData.c_likes || 0}</span> likes
                        </div>
                        <div class="blog-stats-item comment-stats" role="button">
                            <i class="fa-solid fa-comment"></i> ${blogData.c_comments || 0} comments
                        </div>
                    </div>

                    <div class="blog-content">
                        ${contentHtml}
                    </div>
                    
                    <!-- Reactions section -->
                    <div class="reaction-section">
                        <div class="reactions-left">
                            <button class="reaction-btn like-button" id="like-button" title="Like this article">
                                <i class="fa-${blogData.isLiked ? 'solid' : 'regular'} fa-heart"></i>
                                <span class="like-count">${blogData.c_likes || 0}</span>
                            </button>
                            <button class="reaction-btn comment-button" id="comment-button" title="Go to comments">
                                <i class="fa-regular fa-comment"></i>
                                <span>${blogData.c_comments || 0}</span>
                            </button>
                        </div>
                        <button class="reaction-btn bookmark-btn-bottom" id="bookmark-button-bottom" title="Save article">
                            <i class="fa-${blogData.isBookmarked ? 'solid' : 'regular'} fa-bookmark"></i>
                        </button>
                    </div>

                    <!-- Error message display -->
                    <div class="error-message" id="error-message"></div>

                    <!-- Comments Section -->
                    <div class="comments-section">
                        <h3 class="comments-header">Comments (${blogData.c_comments || 0})</h3>

                        <!-- Comment Form -->
                        <div class="comment-form">
                            <textarea class="comment-input" placeholder="Add a comment..."></textarea>
                            <button class="comment-submit">Comment</button>
                        </div>

                        <!-- Comments List -->
                        <div class="comments-list">
                            <!-- Comments will be dynamically loaded -->
                        </div>
                    </div>
                `;

                // Replace loading indicator with blog content
                document.getElementById('blog-container').innerHTML = blogHtml;

                // Bookmark functionality
                const bookmarkButton = document.getElementById('bookmark-button');
                const bookmarkButtonBottom = document.getElementById('bookmark-button-bottom');
                let isBookmarked = blogData.isBookmarked;

                // Set initial bookmark state
                updateBookmarkIcon();

                // Handle top bookmark button click
                bookmarkButton.addEventListener('click', function () {
                    handleBookmarkAction();
                });

                // Handle bottom bookmark button click
                bookmarkButtonBottom.addEventListener('click', function () {
                    handleBookmarkAction();
                });

                function handleBookmarkAction() {
                    if (!USER_ID) {
                        showError("Please login to bookmark this blog");
                        return;
                    }

                    isBookmarked = !isBookmarked;
                    updateBookmarkIcon();
                    
                    // Send bookmark status to server
                    sendBookmarkToServer(isBookmarked);
                }

                function updateBookmarkIcon() {
                    // Update top bookmark button
                    if (isBookmarked) {
                        bookmarkButton.classList.add('active');
                        bookmarkButton.innerHTML = '<i class="fa-solid fa-bookmark"></i>';
                    } else {
                        bookmarkButton.classList.remove('active');
                        bookmarkButton.innerHTML = '<i class="fa-regular fa-bookmark"></i>';
                    }
                    
                    // Update bottom bookmark button
                    if (isBookmarked) {
                        bookmarkButtonBottom.classList.add('active');
                        bookmarkButtonBottom.innerHTML = '<i class="fa-solid fa-bookmark"></i>';
                    } else {
                        bookmarkButtonBottom.classList.remove('active');
                        bookmarkButtonBottom.innerHTML = '<i class="fa-regular fa-bookmark"></i>';
                    }
                }

                function sendBookmarkToServer(bookmarked) {
                    // AJAX call to update bookmark status on server
                    $.ajax({
                        url: 'http://localhost:8080/api/Blog/updateBlogBookmark',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            blogId: BLOG_ID,
                            userId: USER_ID,
                            isBookmarked: bookmarked
                        }),
                        success: function(response) {
                            if (!response.success) {
                                showError("Failed to update bookmark status: " + response.message);
                                // Revert the UI change if server update failed
                                isBookmarked = !isBookmarked;
                                updateBookmarkIcon();
                            }
                        },
                        error: function(xhr, status, error) {
                            showError("Error updating bookmark status: " + error);
                            // Revert the UI change if server update failed
                            isBookmarked = !isBookmarked;
                            updateBookmarkIcon();
                        }
                    });
                }

                // Like functionality
                const likeBlogBtn = document.getElementById('like-blog-btn');
                const likeButton = document.getElementById('like-button');
                let isLiked = blogData.isLiked || false;
                let likeCount = blogData.c_likes || 0;

                // Set initial like state
                updateLikeState();

                // Handle like button clicks (both buttons)
                likeBlogBtn.addEventListener('click', function() {
                    handleLikeAction();
                });

                likeButton.addEventListener('click', function() {
                    handleLikeAction();
                });

                function handleLikeAction() {
                    if (!USER_ID) {
                        showError("Please login to like this blog");
                        return;
                    }

                    isLiked = !isLiked;
                    likeCount = isLiked ? likeCount + 1 : likeCount - 1;
                    updateLikeState();
                    
                    // Send like status to server
                    sendLikeToServer(isLiked);
                }

                function updateLikeState() {
                    // Update both like buttons
                    likeBlogBtn.innerHTML = `<i class="fa-${isLiked ? 'solid' : 'regular'} fa-heart"></i> <span class="like-text">${isLiked ? 'Liked' : 'Like'}</span>`;
                    likeButton.innerHTML = `<i class="fa-${isLiked ? 'solid' : 'regular'} fa-heart"></i> <span class="like-count">${likeCount}</span>`;
                    
                    // Update like count in stats section
                    document.querySelector('.blog-stats .like-count').textContent = likeCount;
                    
                    // Add/remove active class for styling
                    if (isLiked) {
                        likeBlogBtn.classList.add('active');
                        likeButton.classList.add('active');
                    } else {
                        likeBlogBtn.classList.remove('active');
                        likeButton.classList.remove('active');
                    }
                }

                function sendLikeToServer(liked) {
                    // AJAX call to update like status on server
                    $.ajax({
                        url: 'http://localhost:8080/api/Blog/updateBlogLike',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            blogId: BLOG_ID,
                            userId: USER_ID,
                            isLiked: liked
                        }),
                        success: function(response) {
                            if (!response.success) {
                                showError("Failed to update like status: " + response.message);
                                // Revert the UI change if server update failed
                                isLiked = !isLiked;
                                likeCount = isLiked ? likeCount + 1 : likeCount - 1;
                                updateLikeState();
                            }
                        },
                        error: function(xhr, status, error) {
                            showError("Error updating like status: " + error);
                            // Revert the UI change if server update failed
                            isLiked = !isLiked;
                            likeCount = isLiked ? likeCount + 1 : likeCount - 1;
                            updateLikeState();
                        }
                    });
                }

                // Comment submission
                const mainCommentForm = document.querySelector('.comment-form .comment-submit');
                mainCommentForm.addEventListener('click', function () {
                    const commentInput = this.previousElementSibling;
                    const commentText = commentInput.value.trim();

                    if (commentText) {
                        addNewComment(commentText);
                        commentInput.value = '';
                    }
                });
            }

            // Functions to handle comments
            function loadComments(comments) {
                const commentsList = document.querySelector('.comments-list');
                if (!commentsList) return;
                
                commentsList.innerHTML = ''; // Clear existing comments

                // First, render all top-level comments (parent_id is null)
                const topLevelComments = comments.filter(comment => comment.parent_id === null);

                topLevelComments.forEach(comment => {
                    const commentElement = createCommentElement(comment);

                    // Find and add all replies for this comment
                    const repliesContainer = commentElement.querySelector(`.nested-comments`);
                    appendReplies(repliesContainer, comment.id, comments);

                    commentsList.appendChild(commentElement);
                });

                // Attach event listeners after loading comments
                attachCommentEventListeners();
            }

            // Recursive function to append replies
            function appendReplies(container, parentId, allComments) {
                // Find direct replies to this parent
                const replies = allComments.filter(comment => comment.parent_id === parentId);

                replies.forEach(reply => {
                    const replyElement = createCommentElement(reply);

                    // Recursively find and append nested replies
                    const nestedContainer = replyElement.querySelector('.nested-comments');
                    appendReplies(nestedContainer, reply.id, allComments);

                    container.appendChild(replyElement);
                });
            }

            function createCommentElement(comment) {
                // Format profile picture URL
                let avatarUrl = comment.avatar;
                if (avatarUrl && !avatarUrl.startsWith('http')) {
                    avatarUrl = `http://localhost:8081/User_Images/${avatarUrl}`;
                }
                
                const commentElement = document.createElement('div');
                commentElement.className = `comment${comment.isAuthorComment ? ' author-comment' : ''}`;
                @* commentElement.className = 'comment'; *@
                commentElement.id = `comment-${comment.id}`;

                @* commentElement.innerHTML = `
                    <div class="comment-header">
                        <div class="commenter-avatar">
                            <img src="${avatarUrl}" alt="${comment.author}" 
                                onerror="this.src='https://media.istockphoto.com/id/1300845620/vector/user-icon-flat-isolated-on-white-background-user-symbol-vector-illustration.jpg?s=612x612&w=0&k=20&c=yBeyba0hUkh14_jgv1OKqIH0CCSWU_4ckRkAoy2p73o='">
                        </div>
                        <div class="commenter-name">${comment.author}</div>
                        <div class="comment-date">${comment.date}</div>
                    </div>
                    <div class="comment-body">
                        ${comment.text}
                    </div>
                    <div class="comment-actions">
                        <!-- Removed like button as requested -->
                        <button class="comment-action reply-action" data-comment-id="${comment.id}"><i class="fa-solid fa-reply"></i>&nbsp&nbspReply</button>
                    </div>
                    <div class="reply-form" id="reply-form-${comment.id}">
                        <textarea class="comment-input" placeholder="Write your reply..."></textarea>
                        <button class="comment-submit" data-parent-id="${comment.id}">Reply</button>
                    </div>
                    <div class="nested-comments" id="nested-comments-${comment.id}"></div>
                `; *@

                commentElement.innerHTML = `
                    <div class="comment-header">
                        <div class="commenter-avatar">
                            <img src="${avatarUrl}" alt="${comment.author}" 
                                onerror="this.src='https://media.istockphoto.com/id/1300845620/vector/user-icon-flat-isolated-on-white-background-user-symbol-vector-illustration.jpg?s=612x612&w=0&k=20&c=yBeyba0hUkh14_jgv1OKqIH0CCSWU_4ckRkAoy2p73o='">
                        </div>
                        <div class="commenter-name">
                            ${comment.author}
                            ${comment.isAuthorComment ? '<span class="author-badge">Author</span>' : ''}
                        </div>
                        <div class="comment-date">${comment.date}</div>
                    </div>
                    <div class="comment-body">
                        ${comment.text}
                    </div>
                    <div class="comment-actions">
                        <button class="comment-action reply-action" data-comment-id="${comment.id}">
                            <i class="fa-solid fa-reply"></i>&nbsp;&nbsp;Reply
                        </button>
                    </div>
                    <div class="reply-form" id="reply-form-${comment.id}">
                        <textarea class="comment-input" placeholder="Write your reply..."></textarea>
                        <button class="comment-submit" data-parent-id="${comment.id}">Reply</button>
                    </div>
                    <div class="nested-comments" id="nested-comments-${comment.id}"></div>
                `;

                return commentElement;
            }

            // Function to add a new comment
            function addNewComment(text, parentCommentId = null) {
                try {
                    const now = new Date();
                    const commentedAt = Math.floor(now.getTime() / 1000); // Unix timestamp
                    const formattedDateTime = formatDateTime(now);
                    
                    // Get blog ID from current page
                    const blogPostId = getBlogPostIdFromUrl();

                    const payload = {
                        commentId: -1,
                        blogId: BLOG_ID, // You might need to get this dynamically from your blog data
                        userId: USER_ID, // This should be the logged-in user's ID
                        commentedAt: commentedAt,
                        commentContent: text,
                        parentCommentId: parentCommentId === null ? -1 : parentCommentId,
                        userRole: USER_ROLE,
                        authorName: "Default User", // This should be the logged-in user's name
                        authorProfilePicture: "default.png"
                    };

                    $.ajax({
                        url: 'http://localhost:8080/api/Blog/AddNewComment',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(payload),
                        success: function (response) {
                            if (response.success) {
                                const newCommentId = response.comment.commentId.toString();

                                const newComment = {
                                    id: newCommentId,
                                    parent_id: response.comment.parentCommentId,
                                    author: response.comment.authorName,
                                    avatar: response.comment.authorProfilePicture,
                                    date: formatDateTimeFromUnix(response.comment.commentedAt),
                                    text: response.comment.commentContent
                                };

                                commentsData.push(newComment);

                                if (parentCommentId === null) {
                                    // Add as a top-level comment
                                    const commentsList = document.querySelector('.comments-list');
                                    const commentElement = createCommentElement(newComment);
                                    commentsList.insertBefore(commentElement, commentsList.firstChild);
                                } else {
                                    // Add as a reply
                                    const nestedContainer = document.getElementById(`nested-comments-${parentCommentId}`);
                                    if (nestedContainer) {
                                        const replyElement = createCommentElement(newComment);
                                        if (nestedContainer.firstChild) {
                                            nestedContainer.insertBefore(replyElement, nestedContainer.firstChild);
                                        } else {
                                            nestedContainer.appendChild(replyElement);
                                        }
                                    }
                                }

                                updateCommentsCounter(1);
                                attachCommentEventListeners();

                                console.log(`Added new comment with ID: ${newCommentId}, parent_id: ${parentCommentId}`);
                            } else {
                                showError("Failed to add comment: " + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            showError("Error adding comment: " + error);
                        }
                    });

                } catch (error) {
                    showError("Error adding comment: " + error.message);
                }
            }

            function attachCommentEventListeners() {
                // Reply buttons 
                document.querySelectorAll('.reply-action').forEach(button => {
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);

                    newButton.addEventListener('click', function () {
                        const commentId = this.getAttribute('data-comment-id');
                        const replyForm = document.getElementById(`reply-form-${commentId}`);

                        // Check if this form is already active
                        const isCurrentlyActive = replyForm.classList.contains('active');

                        // Close all reply forms first
                        document.querySelectorAll('.reply-form.active').forEach(form => {
                            form.classList.remove('active');
                        });

                        // Only open if it wasn't already active (this creates true toggle behavior)
                        if (!isCurrentlyActive && replyForm) {
                            replyForm.classList.add('active');
                            // Auto-focus the textarea for immediate typing
                            replyForm.querySelector('textarea').focus();
                        }
                    });
                });

                // Submit reply buttons
                document.querySelectorAll('.reply-form .comment-submit').forEach(button => {
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);

                    newButton.addEventListener('click', function () {
                        const replyInput = this.previousElementSibling;
                        const replyText = replyInput.value.trim();
                        const parentId = this.getAttribute('data-parent-id');

                        if (replyText) {
                            addNewComment(replyText, parentId);
                            replyInput.value = '';
                            // Close the reply form after submitting
                            document.getElementById(`reply-form-${parentId}`).classList.remove('active');
                        }
                    });
                });
            }

            // Function to update comments counter
            function updateCommentsCounter(increment) {
                const commentsHeader = document.querySelector('.comments-header');
                if (commentsHeader) {
                    const currentCount = parseInt(commentsHeader.textContent.match(/\d+/) || 0);
                    const newCount = currentCount + increment;
                    commentsHeader.textContent = `Comments (${newCount})`;
                    
                    // Also update the comments stats counter
                    const commentsStats = document.querySelector('.blog-stats-item:has(.fa-comment)');
                    if (commentsStats) {
                        commentsStats.innerHTML = `<i class="fa-solid fa-comment"></i> ${newCount} comments`;
                    }
                }
            }

            // Function to show error message
            function showError(message) {
                const errorMessageElement = document.getElementById('error-message');
                if (errorMessageElement) {
                    errorMessageElement.textContent = message;
                    errorMessageElement.style.display = 'block';
                    
                    // Hide after 5 seconds
                    setTimeout(() => {
                        errorMessageElement.style.display = 'none';
                    }, 5000);
                } else {
                    console.error(message);
                }
            }
        });

    </script>
</body>

</html>
